{% extends "base.html" %}

{% block title %}Análise - Sistema de Trading{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Análise da Carteira (Perfil: {{ risk_profile|title }})</h1>
    
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Resumo da Análise</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Resumo da Carteira</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td>Total Investido:</td>
                                            <td>${{ "%.2f"|format(portfolio_analysis.resumo.total_invested or 0) }}</td>
                                        </tr>
                                        <tr>
                                            <td>Valor Atual:</td>
                                            <td>${{ "%.2f"|format(portfolio_analysis.resumo.valor_atual or 0) }}</td>
                                        </tr>
                                        <tr>
                                            <td>Lucro/Prejuízo:</td>
                                            <td class="{% if (portfolio_analysis.resumo.lucro_prejuízo or 0) >= 0 %}positive{% else %}negative{% endif %}">
                                                ${{ "%.2f"|format(portfolio_analysis.resumo.lucro_prejuízo or 0) }}
                                                ({{ "%.2f"|format(portfolio_analysis.resumo.lucro_prejuízo_pct or 0) }}%)
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Saldo Disponível:</td>
                                            <td>${{ "%.2f"|format(portfolio_analysis.resumo.saldo_disponível or 0) }}</td>
                                        </tr>
                                        <tr>
                                            <td>Patrimônio Total:</td>
                                            <td>${{ "%.2f"|format(portfolio_analysis.resumo.patrimônio_total or 0) }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6>Sentimento de Mercado</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td>Sentimento:</td>
                                            <td>{{ portfolio_analysis.resumo.market_sentiment.sentiment }}</td>
                                        </tr>
                                        <tr>
                                            <td>Tendência:</td>
                                            <td>{{ portfolio_analysis.resumo.market_sentiment.trend }}</td>
                                        </tr>
                                        <tr>
                                            <td>Score de Viés:</td>
                                            <td>{{ "%.2f"|format(portfolio_analysis.resumo.market_sentiment.market_bias_score) }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <a href="/market_sentiment" class="btn btn-sm btn-outline-primary mt-2">Ver Detalhes</a>
                        </div>
                        <div class="col-md-4">
                            {% if portfolio_analysis.resumo.meta_recuperação > 0 %}
                            <h6>Meta de Recuperação</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td>Meta Recuperação:</td>
                                            <td>${{ "%.2f"|format(portfolio_analysis.resumo.meta_recuperação) }}</td>
                                        </tr>
                                        <tr>
                                            <td>Meta Diária:</td>
                                            <td>${{ "%.2f"|format(portfolio_analysis.resumo.meta_diária) }}</td>
                                        </tr>
                                        <tr>
                                            <td>Dias Restantes:</td>
                                            <td>{{ portfolio_analysis.resumo.dias_restantes }}</td>
                                        </tr>
                                        <tr>
                                            <td>Urgência:</td>
                                            <td><div class="progress">
                                                <div class="progress-bar 
                                                    {% if portfolio_analysis.resumo.dias_restantes < 5 %}bg-danger
                                                    {% elif portfolio_analysis.resumo.dias_restantes < 10 %}bg-warning
                                                    {% else %}bg-success{% endif %}" 
                                                    role="progressbar" 
                                                    style="width: {{ 100 - (portfolio_analysis.resumo.dias_restantes / portfolio_analysis.resumo.dias_totais * 100) if portfolio_analysis.resumo.dias_totais else 0 }}%">
                                                </div>
                                            </div></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}
                            
                            <div class="d-grid gap-2 mt-3">
                                <a href="/execute_rebalance" class="btn btn-success" 
                                   onclick="return confirm('Tem certeza que deseja executar o rebalanceamento recomendado? Esta operação modificará sua carteira.')">
                                    <i class="bi bi-shuffle"></i> Executar Rebalanceamento
                                </a>
                                <a href="/optimize" class="btn btn-outline-primary">
                                    <i class="bi bi-sliders"></i> Otimizar Carteira
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Plano de Rebalanceamento -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Plano de Rebalanceamento</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Estatísticas do plano -->
                        <div class="col-lg-4 mb-3">
                            <h6>Estatísticas</h6>
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td>Saldo Inicial:</td>
                                        <td>${{ "%.2f"|format(rebalance_plan.stats.saldo_inicial or 0) }}</td>
                                    </tr>
                                    <tr>
                                        <td>Capital Liberado:</td>
                                        <td>${{ "%.2f"|format(rebalance_plan.stats.capital_liberado_vendas or 0) }}</td>
                                    </tr>
                                    <tr>
                                        <td>Capital Disponível:</td>
                                        <td>${{ "%.2f"|format(rebalance_plan.stats.capital_total_disponivel or 0) }}</td>
                                    </tr>
                                    <tr>
                                        <td>Capital para Compras:</td>
                                        <td>${{ "%.2f"|format(rebalance_plan.stats.capital_usado_compras or 0) }}</td>
                                    </tr>
                                    <tr>
                                        <td>Saldo Remanescente:</td>
                                        <td>${{ "%.2f"|format(rebalance_plan.stats.saldo_remanescente or 0) }}</td>
                                    </tr>
                                    <tr>
                                        <td>Total de Comissões:</td>
                                        <td>${{ "%.2f"|format(rebalance_plan.stats.total_comissoes or 0) }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Vendas recomendadas -->
                        <div class="col-lg-4 mb-3">
                            <h6>Vendas Recomendadas</h6>
                            {% if rebalance_plan.sell %}
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Ticker</th>
                                            <th>Qtde</th>
                                            <th>Preço</th>
                                            <th>Valor</th>
                                            <th>Ação</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in rebalance_plan.sell %}
                                        <tr>
                                            <td>{{ item.ticker }}</td>
                                            <td>{{ item.sell_quantity }}</td>
                                            <td>${{ "%.2f"|format(item.current_price) }}</td>
                                            <td>${{ "%.2f"|format(item.operation_value) }}</td>
                                            <td>
                                                <a href="/trade?ticker={{ item.ticker }}&quantity={{ item.sell_quantity }}&price={{ '%.2f'|format(item.current_price) }}&trade_type=VENDA" class="btn btn-sm btn-outline-danger">
                                                    Vender
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <p class="text-center py-2">Nenhuma venda recomendada</p>
                            {% endif %}
                            
                            {% if rebalance_plan.rebalance %}
                            <h6 class="mt-3">Rebalanceamentos</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Ticker</th>
                                            <th>Qtde</th>
                                            <th>Preço</th>
                                            <th>Valor</th>
                                            <th>Ação</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in rebalance_plan.rebalance %}
                                        <tr>
                                            <td>{{ item.ticker }}</td>
                                            <td>{{ item.sell_quantity }}</td>
                                            <td>${{ "%.2f"|format(item.current_price) }}</td>
                                            <td>${{ "%.2f"|format(item.operation_value) }}</td>
                                            <td>
                                                <a href="/trade?ticker={{ item.ticker }}&quantity={{ item.sell_quantity }}&price={{ '%.2f'|format(item.current_price) }}&trade_type=VENDA" class="btn btn-sm btn-outline-warning">
                                                    Rebalancear
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Compras recomendadas -->
                        <div class="col-lg-4 mb-3">
                            <h6>Compras Recomendadas</h6>
                            {% if rebalance_plan.buy %}
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Ticker</th>
                                            <th>Qtde</th>
                                            <th>Preço</th>
                                            <th>Custo</th>
                                            <th>Ação</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in rebalance_plan.buy %}
                                        <tr>
                                            <td>{{ item.ticker }}</td>
                                            <td>{{ item.buy_quantity }}</td>
                                            <td>${{ "%.2f"|format(item.current_price) }}</td>
                                            <td>${{ "%.2f"|format(item.total_cost) }}</td>
                                            <td>
                                                <a href="/trade?ticker={{ item.ticker }}&quantity={{ item.buy_quantity }}&price={{ '%.2f'|format(item.current_price) }}&trade_type=COMPRA" class="btn btn-sm btn-outline-success">
                                                    Comprar
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <p class="text-center py-2">Nenhuma compra recomendada</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Análise de Ativos -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Análise da Carteira</h5>
                    <div class="btn-group">
                        <a href="/analyze?risk=low" class="btn btn-sm btn-outline-primary {% if risk_profile == 'low' %}active{% endif %}">Baixo</a>
                        <a href="/analyze?risk=medium" class="btn btn-sm btn-outline-primary {% if risk_profile == 'medium' %}active{% endif %}">Médio</a>
                        <a href="/analyze?risk=high" class="btn btn-sm btn-outline-primary {% if risk_profile == 'high' %}active{% endif %}">Alto</a>
                        <a href="/analyze?risk=ultra" class="btn btn-sm btn-outline-primary {% if risk_profile == 'ultra' %}active{% endif %}">Ultra</a>
                        <a href="/analyze?risk={{ risk_profile }}&extended=true" class="btn btn-sm btn-outline-primary {% if extended_hours %}active{% endif %}">Extended Hours</a>
                    </div>
                </div>
                <div class="card-body">
                    {% if portfolio_analysis.ativos %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Ticker</th>
                                    <th>Preço</th>
                                    <th>Score</th>
                                    <th>P/L</th>
                                    <th>Decisão</th>
                                    <th>Justificativa</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ticker, details in portfolio_analysis.ativos.items() %}
                                {% if "error" not in details %}
                                <tr>
                                    <td>{{ ticker }}</td>
                                    <td>${{ "%.2f"|format(details.current_price) }}</td>
                                    <td>{{ "%.2f"|format(details.total_score) }}</td>
                                    <td class="{% if details.position_profit_pct >= 0 %}positive{% else %}negative{% endif %}">
                                        {{ "%.2f"|format(details.position_profit_pct) }}%
                                    </td>
                                    <td>
                                        <span class="badge {% if details.decision in ['COMPRAR', 'COMPRAR PARCIAL'] %}bg-success{% elif details.decision in ['VENDER', 'REALIZAR LUCRO PARCIAL', 'REDUZIR'] %}bg-danger{% else %}bg-secondary{% endif %}">
                                            {{ details.decision }}
                                        </span>
                                    </td>
                                    <td>{{ details.justificativa }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="/indicators?ticker={{ ticker }}" class="btn btn-sm btn-outline-primary" title="Técnica">
                                                <i class="bi bi-activity"></i>
                                            </a>
                                            <a href="/fundamentals?ticker={{ ticker }}" class="btn btn-sm btn-outline-info" title="Fundamentos">
                                                <i class="bi bi-file-text"></i>
                                            </a>
                                            <a href="/news?ticker={{ ticker }}" class="btn btn-sm btn-outline-warning" title="Notícias">
                                                <i class="bi bi-newspaper"></i>
                                            </a>
                                            {% if details.decision in ['COMPRAR', 'COMPRAR PARCIAL'] and details.position_sizing and details.position_sizing.suggested_shares > 0 %}
                                            <a href="/trade?ticker={{ ticker }}&quantity={{ details.position_sizing.suggested_shares }}&price={{ '%.2f'|format(details.current_price) }}&trade_type=COMPRA" class="btn btn-sm btn-outline-success" title="Comprar mais">
                                                <i class="bi bi-cart-plus"></i> {{ details.position_sizing.suggested_shares }}
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center py-3">Nenhum ativo para análise</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Análise da Watchlist -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Análise da Watchlist</h5>
                </div>
                <div class="card-body">
                    {% if watchlist_analysis %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Ticker</th>
                                    <th>Preço</th>
                                    <th>Score</th>
                                    <th>Decisão</th>
                                    <th>Justificativa</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ticker, details in watchlist_analysis.items() %}
                                {% if "error" not in details %}
                                <tr>
                                    <td>{{ ticker }}</td>
                                    <td>${{ "%.2f"|format(details.current_price) }}</td>
                                    <td>{{ "%.2f"|format(details.total_score) }}</td>
                                    <td>
                                        <span class="badge {% if details.decision in ['COMPRAR', 'COMPRAR PARCIAL'] %}bg-success{% elif details.decision in ['VENDER', 'REALIZAR LUCRO PARCIAL', 'REDUZIR'] %}bg-danger{% else %}bg-secondary{% endif %}">
                                            {{ details.decision }}
                                        </span>
                                    </td>
                                    <td>{{ details.justificativa }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="/indicators?ticker={{ ticker }}" class="btn btn-sm btn-outline-primary" title="Técnica">
                                                <i class="bi bi-activity"></i>
                                            </a>
                                            <a href="/fundamentals?ticker={{ ticker }}" class="btn btn-sm btn-outline-info" title="Fundamentos">
                                                <i class="bi bi-file-text"></i>
                                            </a>
                                            {% if details.decision in ['COMPRAR', 'COMPRAR PARCIAL'] and details.position_sizing and details.position_sizing.suggested_shares > 0 %}
                                            <a href="/trade?ticker={{ ticker }}&quantity={{ details.position_sizing.suggested_shares }}&price={{ '%.2f'|format(details.current_price) }}&trade_type=COMPRA" class="btn btn-sm btn-outline-success" title="Comprar">
                                                <i class="bi bi-cart-plus"></i> {{ details.position_sizing.suggested_shares }}
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center py-3">Nenhum ativo na watchlist para análise</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Scripts adicionais para a página de análise
    document.addEventListener('DOMContentLoaded', function() {
        // Configuração para links de execução de rebalanceamento
        const executeRebalanceForm = document.getElementById('execute-rebalance-form');
        if (executeRebalanceForm) {
            executeRebalanceForm.addEventListener('submit', function(event) {
                if (!confirm('Tem certeza que deseja executar o rebalanceamento recomendado? Esta operação modificará sua carteira.')) {
                    event.preventDefault();
                }
            });
        }
    });
</script>
{% endblock %}